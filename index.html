<html>
<head>
    <title>Phlask Map</title>
    <style type="text/css">
        /* map specific */
        #map {
					height: 650px;
        }
        /* sidebar */
        .sidebar {
            height: 650px;
            float: left;
            width: 20%;
            min-width: 225px;
            display: none;
            border-right: #00ADEE solid 3px;
            padding-left: 15px;
            padding-top: 15px;
			      overflow: auto;
        }
        .sidebar strong {
          color: #00ADEE;
        }
        .field-desccription {
            margin-top: 0px;
            font-size: 10px;
            max-width: 175px;
        }
        .field-with-text {
            padding-top: 15px;
        }
        .location-description {
            max-height: 200px;
            min-height: 50px;
            max-width: 200px;
            min-width: 200px;
            width: 200px;
            font-size: 10px;
        }
        .phlask-logo {
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 20px;
        }
        .sidebar-button {
            display: block;
            margin-right: 10px;
            margin-bottom: 25px;
            margin-left: 100px;
            background-color: #00ADEE;
            border: none;
            color: white;
            padding: 5px;
            text-align: center;
            text-decoration: none;
            font-size: 16px;
            float: right;
        }
        .directions-button {
          margin: auto;
          display: block;
          margin-bottom: 25px;
          background-color: #00ADEE;
          border: none;
          color: white;
          padding: 5px;
          text-align: center;
          text-decoration: none;
          font-size: 16px;
          width: 50%
        }
        .edit-button {
            display: block;
            margin-right: 10px;
            margin-bottom: 25px;
            margin-left: 100px;
            padding-bottom: 25px;
            background-color: #00ADEE;
            border: none;
            color: white;
            padding: 5px;
            text-align: center;
            text-decoration: none;
            font-size: 16px;
        }
        /* edit form */
        #editForm {
          all: unset;
          display: none;
          overflow: visible;
          width: 35em;
          margin:0 auto;
        }

        /* intake form */
        #form {
            all: unset;
            display: none;
            overflow: visible;
            width: 35em;
            margin:0 auto;
        }
        td {
            padding-bottom: 5px;
            padding-right: 10px;
        }
        input[type="text"], input[type="search"], input[type="email"], input[type="tel"] {
          margin-bottom: 0px;
        }
        .section-break {
            padding-top: 25px;
        }
        button, input, select, textarea {
          font-family: 50px;
          width: 75px;
        }
        #new-tap-submit {
          display: none;
          text-align: center;
        }
        #edit-tap-submit {
          display: none;
          text-align: center;
        }
        .phlask-code-input {
          width: 150px;
          text-align: center;
          color: #00ADEE;
        }
        /* success message */
        #message {
            display: none;
            text-align: center;
        }
        /* legend */
        #legend {
            font-family: Arial, sans-serif;
            background: #fff;
            padding: 10px;
            margin: 10px;
            margin-bottom: 0px;
            border: 1px solid #000;
            display: none;
            transform: scale(.9, .9);
        }
        #legend img {
            vertical-align: middle;
            padding-bottom: 10px;
            padding-top: 5px;
        }
        #legend h3 {
          margin-bottom: 0;
          font-size: 20px;
          text-align: center;
        }
        #filter {
          display: none;
          font-family: Arial, sans-serif;
          background: #fff;
          padding: 10px;
          margin: 10px;
          margin-bottom: 0px;
          border: 1px solid #000;
          display: none;
          transform: scale(.9, .9);
        }
        .filter-label {
          margin: 0px;
          padding: 0px;
        }
        .filter-input {
          margin: 0px;
          padding: 0px;
        }
        /* Image Gallery */
        .image-gallery {
          /* overflow-x: scroll; */
          /* overflow-y: hidden; */
          height: 300px;
          width: 90%;
          white-space: nowrap;
          margin: 0 auto;
          margin-bottom: 20px;
        }
        .scroll-buttons {
          width: 90%;
          margin: 0 auto;
        }
        .image-btn {
          width: 25px;
        }
        #geo-locate {
          margin-right: 5px;
          background: white;
          display: none;
        }
        #latlon-div {
          margin-left: 10px;
          display: none;
        }
        #latlon-input {

        }
        #latlon-button {
          border: 2px solid #00ADEE;
        }
        .phlask-code-input {
          display: none;
        }
        /* Mobile Specific Sytle Rules */
        @media only screen and (max-device-width: 480px) {
          #form {
            width: 90%;
            order: 3;
          }
          #form input {
            width: 90%;
          }
          #main {
            display:flex;
            flex-direction:column;
          }
          .sidebar {
            order: 2;
            clear: both;
          }
          #map {
            order: 1;
          }
          .sidebar {
            overflow: scroll;
            width: 100%;
            height: 210px; }
          }
        }
    </style>
</head>

<body>
    <!-- HTML strucutre -->
    <!-- Sidebar -->
    <div class="sidebar" id="mySidebar"></div>
    <!-- map -->
		<div id="map"></div>
    <!-- legend -->
    <div id="legend"><h3>Legend</h3></div>
    <div id="filter"><h3>Filter Taps</h3>
      <label class="filter-label">
        All Taps
        <input class="filter-input" type="radio" name="filterToggle" value="All Taps" checked>
      </label>
      <label class="filter-label">
        Public Taps
        <input class="filter-input" type="radio" name="filterToggle" value="Public Taps">
      </label>
      <label class="filter-label">
        Private Taps
      <input class="filter-input" type="radio" name="filterToggle" value="Private Taps">
      </label>
    </div>
    <img id="geo-locate" src='https://i.imgur.com/wWc1rmZ.png'></img>
    <div id='latlon-div'><input type="text" name="latlon" value="" placeholder="Enter an address" id='latlon-input'><button id="latlon-button" >Go there!</button></div>

    <!-- new tap form -->
    <div id="form" class="form">
      <table>
      <tr><td class="field-with-text"><strong>Enterprise / Facility: </strong><p class="field-desccription">Name of enterprise (business or organization) or facility (train station, park, etc.) where the tap is located.</p></td> <td><input type='text' id='org'/></td></tr>

      <tr><td><strong>Address:</strong></td><td><input type='text' id='address'/> </td> </tr>

      <tr><td><strong>City:</strong></td><td><input type='text' id='city' value='Philadelphia'/> </td> </tr>

      <tr><td><strong>Zip Code:</strong></td><td><input type='text' id='zipcode'/> </td></tr>

      <tr><td class="field-with-text"><strong>Handicap Accessible:</strong><p class="field-desccription">Is the tap accessible according to ADA standards?</p></td><td><select id='handicap'> +
                 <option value='' style="display:none">
                 <option value='Yes'>Yes</option>
                 <option value='No'>No</option>
                 <option value='Unsure'>Unsure</option>
                 </select></td></tr>

      <tr><td><strong>Tap Access:</strong></td><td><select id='access'> +
                 <option value='' style="display:none">
                 <option value='Public'>Public</option>
                 <option value='Semi-public'>Semi-public</option>
                 <option value='Private'>Private</option>
                 </select> </td></tr>

      <tr><td><strong>Description of on-site<br>tap location:</strong></td><td>
      <textarea class='location-description' id='description'></textarea></td></tr>

      <tr><td><strong>Tap Type:</strong></td><td><select id='tap-type'> +
                 <option value='' style="display:none">
                 <option value='Drinking fountain' >Drinking Fountain</option>
                 <option value='Bottle filler and fountain' >Bottle Filler & Fountain</option>
                 <option value='Sink'>Sink</option>
                 <option value='Soda fountain'>Soda Fountain</option>
                 <option value='Dedicated water dispenser'>Dedicated Water Dispenser</option>
                 <option value='Water cooler'>Water Cooler</option>
                 <option value='Other'>Other</option>
                 </select> </td></tr>

      <tr><td><strong>Tap Service:</strong></td><td><select id='service'> +
                 <option value='' style="display:none">
                 <option value='Self-serve' >Self-Serve</option>
                 <option value='Ask proprietor'>Ask Proprietor</option>
                 </select></td></tr>


      <tr><td><strong>Filtration:</strong></td><td><select id='filtration'> +
                 <option value='' style="display:none">
                 <option value='Yes' >Yes, Filtered</option>
                 <option value='No'>No, Unfiltered</option>
                 <option value='Unsure'>Unsure</option>
                 </select> </td></tr>

      <tr><td><strong>Water Vessel:</strong></td><td><select id='vessel'> +
                 <option value='' style="display:none">
                 <option value='Yes'>Yes, cups or vessel available on-site</option>
                 <option value='No'>No, BYO Phlask</option>
                 <option value='Unsure'>Unsure</option>
                 </select> </td></tr>

      <tr><td><strong>PHLASK Statement:</strong><p class="field-desccription">Please use this section to make any statement about your organization or enterprise!</p></td><td>
      <textarea class='location-description' id='statement'></textarea></td></tr>

      <tr><td><strong>PHLASKing norms and rules</strong><p class="field-desccription">PHLASKing is intended to be an unobtrusive part of doing business. If there are special norms associated with accessing water, please use this space to describe them.</p></td><td>
      <textarea class='location-description' id='norms-rules'></textarea></td></tr>

			<!-- <tr><td><strong>Add Images</strong></td><td><input type='file' id='image-upload' name='Image Upload' accept="image/*" multiple/></td></tr> -->
      <tr id='last-form-row'><td></td><td><input type='button' value='Save' onclick='saveData()' class="save-button"/></td></tr>
      </table>
      <h2 id='new-tap-submit'>Tap Submitted!</h2>
    </div>


    <div id="editForm" class="form">
      <table>
      <tr><td class="field-with-text"><strong>Enterprise / Facility: </strong><p class="field-desccription">Name of enterprise (business or organization) or facility (train station, park, etc.) where the tap is located.</p></td> <td><input type='text' id='edit-org'/></td></tr>

      <tr><td><strong>Address:</strong></td><td><input type='text' id='edit-address'/> </td> </tr>

      <tr><td><strong>City:</strong></td><td><input type='text' id='edit-city' value='Philadelphia'/> </td> </tr>

      <tr><td><strong>Zip Code:</strong></td><td><input type='text' id='edit-zipcode'/> </td></tr>

      <tr><td class="field-with-text"><strong>Handicap Accessible:</strong><p class="field-desccription">Is the tap accessible according to ADA standards?</p></td><td><select id='edit-handicap'> +
                 <option value='' style="display:none">
                 <option value='Yes'>Yes</option>
                 <option value='No'>No</option>
                 <option value='Unsure'>Unsure</option>
                 </select></td></tr>

      <tr><td><strong>Tap Access:</strong></td><td><select id='edit-access'> +
                 <option value='' style="display:none">
                 <option value='Public'>Public</option>
                 <option value='Semi-public'>Semi-public</option>
                 <option value='Private'>Private</option>
                 </select> </td></tr>

      <tr><td><strong>Description of on-site<br>tap location:</strong></td><td>
      <textarea class='location-description' id='edit-description'></textarea></td></tr>

      <tr><td><strong>Tap Type:</strong></td><td><select id='edit-tap-type'> +
                 <option value='' style="display:none">
                 <option value='Drinking fountain' >Drinking Fountain</option>
                 <option value='Bottle filler and fountain' >Bottle Filler & Fountain</option>
                 <option value='Sink'>Sink</option>
                 <option value='Soda fountain'>Soda Fountain</option>
                 <option value='Dedicated water dispenser'>Dedicated Water Dispenser</option>
                 <option value='Water cooler'>Water Cooler</option>
                 <option value='Other'>Other</option>
                 </select> </td></tr>

      <tr><td><strong>Tap Service:</strong></td><td><select id='edit-service'> +
                 <option value='' style="display:none">
                 <option value='Self-serve' >Self-Serve</option>
                 <option value='Ask proprietor'>Ask Proprietor</option>
                 </select></td></tr>


      <tr><td><strong>Filtration:</strong></td><td><select id='edit-filtration'> +
                 <option value='' style="display:none">
                 <option value='Yes' >Yes, Filtered</option>
                 <option value='No'>No, Unfiltered</option>
                 <option value='Unsure'>Unsure</option>
                 </select> </td></tr>

      <tr><td><strong>Water Vessel:</strong></td><td><select id='edit-vessel'> +
                 <option value='' style="display:none">
                 <option value='Yes'>Yes, cups or vessel available on-site</option>
                 <option value='No'>No, BYO Phlask</option>
                 <option value='Unsure'>Unsure</option>
                 </select> </td></tr>

      <tr><td><strong>PHLASK Statement:</strong><p class="field-desccription">Please use this section to make any statement about your organization or enterprise!</p></td><td>
      <textarea class='location-description' id='edit-statement'></textarea></td></tr>

      <tr><td><strong>PHLASKing norms and rules</strong><p class="field-desccription">PHLASKing is intended to be an unobtrusive part of doing business. If there are special norms associated with accessing water, please use this space to describe them.</p></td><td>
      <textarea class='location-description' id='edit-norms-rules'></textarea></td></tr>

			<!-- <tr><td><strong>Add Images</strong></td><td><input type='file' id='image-upload' name='Image Upload' accept="image/*" multiple/></td></tr> -->
      <tr><td></td><td class="phlask-code-input-td"><input placeholder="Enter Phlask Edit Code" class="phlask-code-input"></td></tr>
      <tr id='last-form-row'><td></td><td><input type='button' value='Save Edit' class="save-button edit-submit"/></td></tr>
      </table>
      <h2 id='edit-tap-submit'>Tap Submitted!</h2>
    </div>

    <!-- new tap submit success message -->
    <div id="message">Tap Location Submitted<br>and Awaiting Verification!</div>

      <!-- google maps API -->
			<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&key=AIzaSyDxIuJdCSTm7yDQaShtWq7-sI3KOsrn30w"></script>
      <!-- firebase API -->
	    <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
      <script src="https://unpkg.com/popper.js/dist/umd/popper.min.js"></script>


			<script type="text/javascript">
      // runs initMap function on window load
			google.maps.event.addDomListener(window, 'load', initMap);

      // global variables
      var map;
      var marker;
      var tapwindow;
      let nextTapNumber = 0;
      let tapMarkers = [];
      let addressMarkers = [];


      let allTaps = [];
      let initialTaps = [];

      let accessFilterType = '';
      let otherFilterType = '';


       const greyStyleRules = [ { "elementType": "geometry", "stylers": [ { "color": "#f5f5f5" } ] }, { "elementType": "labels.icon", "stylers": [ { "visibility": "off" } ] }, { "elementType": "labels.text.fill", "stylers": [ { "color": "#616161" } ] }, { "elementType": "labels.text.stroke", "stylers": [ { "color": "#f5f5f5" } ] }, { "featureType": "administrative.land_parcel", "elementType": "labels.text.fill", "stylers": [ { "color": "#bdbdbd" } ] }, { "featureType": "poi", "elementType": "geometry", "stylers": [ { "color": "#eeeeee" } ] }, { "featureType": "poi", "elementType": "labels.text.fill", "stylers": [ { "color": "#757575" } ] }, { "featureType": "poi.park", "elementType": "geometry", "stylers": [ { "color": "#e5e5e5" } ] }, { "featureType": "poi.park", "elementType": "labels.text.fill", "stylers": [ { "color": "#9e9e9e" } ] }, { "featureType": "road", "elementType": "geometry", "stylers": [ { "color": "#ffffff" } ] }, { "featureType": "road.arterial", "elementType": "labels.text.fill", "stylers": [ { "color": "#757575" } ] }, { "featureType": "road.highway", "elementType": "geometry", "stylers": [ { "color": "#dadada" } ] }, { "featureType": "road.highway", "elementType": "labels.text.fill", "stylers": [ { "color": "#616161" } ] }, { "featureType": "road.local", "elementType": "labels.text.fill", "stylers": [ { "color": "#9e9e9e" } ] }, { "featureType": "transit.line", "elementType": "geometry", "stylers": [ { "color": "#e5e5e5" } ] }, { "featureType": "transit.station", "elementType": "geometry", "stylers": [ { "color": "#eeeeee" } ] }, { "featureType": "water", "elementType": "geometry", "stylers": [ { "color": "#c9c9c9" } ] }, { "featureType": "water", "elementType": "labels.text.fill", "stylers": [ { "color": "#9e9e9e" } ] } ]

      // map icons for tap types
      // public
      const blueTap = "https://i.imgur.com/M12e1HV.png"
      // semi-public
      const greenTap = "https://i.imgur.com/DXMMxXR.png"
      // selected
      const yellowTap = "https://i.imgur.com/kt825XO.png"
      // private
      const redTap = "https://i.imgur.com/5NOdOyY.png"
      // unverified
      const greyTap = "https://i.imgur.com/kKXG3TO.png"

      const HOSR_tap = "https://i.imgur.com/cZ3GxdF.png"
      const HOSR_grey_tap = 'https://i.imgur.com/bnw3Erx.png'

      const userLocation = "https://i.imgur.com/ofjiRtT.png"
      const locateMeIcon = "https://i.imgur.com/wWc1rmZ.png"

      // array to store selected tap for symbology change
      const selected_taps = [];

      const locationMarker = new google.maps.Marker({
          map: map,
          draggable: false,
          icon: userLocation
      })

      let smallScreen = false
      if (window.innerWidth <= 480) {
        smallScreen = true;
        document.getElementById("map").style.height = "600px";
      }

      function goToLocation() {
        let latLon = document.getElementById('latlon-input').value;
        console.log(latLon);

        let lat = '';
        let lng = '';

        try {
          lat = latLon.split(',')[0].trim();
          lng = latLon.split(',')[1].trim();
        }
        catch(err) {
          alert("Invalid address");
        }

        if (!isNaN(lat) && !isNaN(lng)) {
          lat = parseFloat(lat);
          lng = parseFloat(lng);

          var position = {lat: lat, lng: lng};
          // const myLocation = new google.maps.Marker({
          //     map: map,
          //     position: position,
          //     icon: userLocation
          //    })

          locationMarker.setPosition(position);
          locationMarker.setMap(map);
          map.setZoom(18);
          map.panTo(position);
          console.log("Made it here");
        }
        else {
          alert("Invalid address.");
        }
      }

      // opens side bar
      function side_open() {
          if (smallScreen) {
            document.getElementById("mySidebar").style.display = "inline-block";
            document.getElementById("map").style.height = "400px";
          }
          else { document.getElementById("mySidebar").style.display = "block"; }
      }

      // closes side bar
      function side_close() {
          document.getElementById("mySidebar").style.display = "none";
          document.getElementById("map").style.height = "600px";
          change_icon_back();
      }

      // initalizes google map, new tap info window, tap submitted message window, new tap marker, event listeners, and legend
      function initMap() {
          map = new google.maps.Map(document.getElementById('map'), {
              center: {lat: 39.952406, lng: -75.163678},
              zoom: 12,
              disableDoubleClickZoom: true,
              gestureHandling: 'greedy',
              //styles: greyStyleRules,

          });

          messagewindow = new google.maps.InfoWindow({
              content: document.getElementById('message')
          });

          marker = new google.maps.Marker({
              map: map,
              draggable: true
          })

          // const toolTip = new google.maps.InfoWindow({
          //   content: "Click to submit a new tap"
          // });
          //
          // google.maps.event.addListener(marker, 'mouseover', function() {
          //   toolTip.open(map, marker);
          // });
          //


          // google.maps.event.addListener(marker, 'mouseout', function() {
          //   toolTip.close();
          // });

          google.maps.event.addListener(map, 'click', function(event) {
              marker.setMap(map);
              marker.setVisible(true);
              messagewindow.close();
              // placeMarker(event.latLng, map, marker);
            });

            getTaps(true);
            getNewTaps();



          // create legend and add legend items
          const legend = document.getElementById('legend');
          const filter = document.getElementById('filter');

          var selected_div = document.createElement('div');
          selected_div.innerHTML = '<img src="' + greyTap + '"> ' + "Selected Tap";
          //legend.appendChild(selected_div);

          var public_div = document.createElement('div');
          public_div.innerHTML = '<img src="' + blueTap + '"> ' + "Public Tap";
          public_div.addEventListener('click', function() {accessFilter('Public')});
          legend.appendChild(public_div);

          var semi_div = document.createElement('div');
          semi_div.innerHTML = '<img src="' + greenTap + '"> ' + "Private-Shared Tap";
          semi_div.addEventListener('click', function() {accessFilter('Private-Shared')});
          legend.appendChild(semi_div);

          var private_div = document.createElement('div');
          private_div.innerHTML = '<img src="' + yellowTap + '"> ' + "Private Tap";
          private_div.addEventListener('click', function() {accessFilter('Private')});
          legend.appendChild(private_div);

          var restricted_div = document.createElement('div');
          restricted_div.innerHTML = '<img src="' + redTap + '"> ' + "Restricted Tap";
          restricted_div.addEventListener('click', function() {accessFilter('Restricted')});
          legend.appendChild(restricted_div);

          // var unconfirmed_div = document.createElement('div');
          // unconfirmed_div.innerHTML = '<img src="' + greyTap + '"> ' + "Un-verified Tap";
          // legend.appendChild(unconfirmed_div);

          var geoLocate = document.querySelector('#geo-locate');
          //geoLocate.style.display = 'none';
          //geoLocate.addListener('click', locateMe());
          google.maps.event.addDomListener(geoLocate, 'click', () => {
            jQuery.post( "https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyDxIuJdCSTm7yDQaShtWq7-sI3KOsrn30w", function(success) {
              showPosition(success);
          		//alert(success.location.lat + ", " + success.location.lng);
            })
            .fail(function(err) {
              alert("Geolocation Failure");
            });
          });

          function showPosition(position) {
            var position = {lat: position.location.lat, lng: position.location.lng};
            // const myLocation = new google.maps.Marker({
            //     map: map,
            //     position: position,
            //     icon: userLocation
            //    })
            locationMarker.setPosition(position);
            locationMarker.setMap(map);

            map.setZoom(20);
            map.panTo(position);
          }

          latLonDiv = document.getElementById('latlon-div');
          //latLonDiv.style.display = 'none';

          google.maps.event.addListenerOnce(map, 'tilesloaded', function() {
            map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(legend);
            legend.style.display = "block";
            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(filter);
            //filter.style.display = "block";
            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(geoLocate);
            //geoLocate.style.display = 'block';
            map.controls[google.maps.ControlPosition.LEFT_TOP].push(latLonDiv);
            latLonDiv.style.display = 'block';
          });
     }

       // firebase configuration for verified taps database
       var config = {
           apiKey: "AIzaSyABw5Fg78SgvedyHr8tl-tPjcn5iFotB6I",
           authDomain: "phlask-web-map.firebaseapp.com",
           databaseURL: "https://phlask-web-map.firebaseio.com",
           projectId: "phlask-web-map",
           storageBucket: "phlask-web-map.appspot.com",
           messagingSenderId: "428394983826"
         };
       firebase.initializeApp(config);

       var database = firebase.database();

       // firebase configuration for new taps database
       var config_new = {
           apiKey: "AIzaSyA2E1tiV34Ou6CJU_wzlJtXxwATJXxi6K8",
           authDomain: "phlask-web-map-new-taps.firebaseapp.com",
           databaseURL: "https://phlask-web-map-new-taps.firebaseio.com",
           projectId: "phlask-web-map-new-taps",
           storageBucket: "phlask-web-map-new-taps.appspot.com",
           messagingSenderId: "673087230724"
       };

       // Initialize another app with a different config
       var secondary = firebase.initializeApp(config_new, "new");

       // Retrieve the database.
       var newDatabase = secondary.database();

    // function used to place new tap marker
		function placeMarker(position, map, marker) {
				marker.setPosition(position)

				google.maps.event.addListener(marker, 'click', function() {
						try {
                // document.getElementById('new-tap-submit').style.display = 'none';
                // document.getElementById('edit-tap-submit').style.display = 'none';
                //
                // var form = document.getElementById("form");
								// form.style.display = "block"
                //
                // document.getElementById("editForm").style.display = 'none';
                //
                // form.scrollIntoView();
                // window.scrollBy(0, -65);
						}
						catch(err) {}
						//infowindow.open(map, this);
            side_close();
            const submitMessage = document.getElementById('new-tap-submit');
            submitMessage.style.display = 'none';

            document.getElementById('access').value = '';
            document.getElementById('service').value = '';
            document.getElementById('tap-type').value = '';
            document.getElementById('vessel').value = '';
            document.getElementById('filtration').value = '';

            document.getElementById('address').value = '';
            document.getElementById('city').value = 'Philadelphia';
            document.getElementById('zipcode').value = '';
            document.getElementById('org').value = '';

            document.getElementById('handicap').value = '';
            document.getElementById('description').value = '';
            document.getElementById('statement').value = '';
            document.getElementById('norms-rules').value = '';
						});

				google.maps.event.addListener(marker, 'dblclick', function(e) {
            e.preventDefault()
						marker.setMap(null);
						infowindow.close();
						});
		 }

    // function used to place and symbolize verified taps
		function placeTap(position, map, data, isNew=false) {
				if (isNew) {
						var tap = new google.maps.Marker({
								position: position,
								map: map,
								icon: greyTap,
								data: data,
                temporary: true
						});
				}
        else if (data.access == 'Public') {
						var tap = new google.maps.Marker({
								position: position,
								map: map,
								icon: blueTap,
								data: data
						});
				}
        else if (data.access == 'Semi-public') {
						var tap = new google.maps.Marker({
								position: position,
								map: map,
								icon: greenTap,
								data: data
						});
				}
				else if (data.access == 'Private') {
						var tap = new google.maps.Marker({
								position: position,
								map: map,
								icon: yellowTap,
								data: data
						});
				}
        else if (data.access == 'Unverified') {
						var tap = new google.maps.Marker({
								position: position,
								map: map,
								icon: greyTap,
								data: data
						});
				}
        else if (data.access == 'Restricted') {
						var tap = new google.maps.Marker({
								position: position,
								map: map,
								icon: redTap,
								data: data
						});
				}
        else if (data.access == 'Private-Shared') {
						var tap = new google.maps.Marker({
								position: position,
								map: map,
								icon: greenTap,
								data: data
						});
				}

        else if (data.access == 'WM') {
						var tap = new google.maps.Marker({
								position: position,
								// map: map,
								icon: HOSR_tap,
								data: data
						});
				}

				tapwindow = new google.maps.InfoWindow({
						content:
						 "<p>" + "<strong>Organization/Enterprise: </strong>" + data.organization + "</p>" +
						 "<p>" + "<strong>Handicap Accessible: </strong>" + data.handicap + "</p>" +
             "<p>" + "<strong>Address: </strong>" + data.address + "</p>" +
             "<p>" + "<strong>City: </strong>" + data.city + "</p>" +
             "<p>" + "<strong>Zip Code: </strong>" + data.zip_code + "</p>" +
						 "<p>" + "<strong>Access: </strong>" + data.access + "</p>" +
						 "<p>" + "<strong>Description: </strong>" + data.description + "</p>" +
						 "<p>" + "<strong>Tap Type: </strong>" + data.tap_type + "</p>" +
						 "<p>" + "<strong>Service: </strong>" + data.service + "</p>" +
						 "<p>" + "<strong>Filtration: </strong>" + data.filtration + "</p>" +
						 "<p>" + "<strong>Water Vessel: </strong>" + data.vessel + "</p>" +
						 "<p>" + "<strong>Phlask Statement: </strong>" + data.statement + "</p>" +
						 "<p>" + "<strong>Norms and Rules: </strong>" + data.norms_rules + "</p>" +

						 "<p>" + "<strong>Tap ID: </strong>" + data.tapnum + "</p>" +
						 "<p>" + "<strong>Latitude: </strong>" + data.lat + "</p>" +
						 "<p>" + "<strong>Longitude: </strong>" + data.lon + "</p>"
				 });

         // console.log(tap)
				tap.addListener('click', function() {
            console.log(this.data);
            slideIndex = 1

            change_icon_back();

            if (tap.data.access == "WM") tap.setIcon(HOSR_grey_tap);
            else tap.setIcon(greyTap);

            selected_taps.push(tap);

						side_open();
						document.getElementById('mySidebar').innerHTML = `
								<button class="sidebar-button"
									onclick="side_close()">Close &times;</button>
								<img class='phlask-logo' src="https://i.imgur.com/YJhx0N9.png" height='34' width='175'>
                <div class="scroll-buttons" id='scroll-buttons'></div>
                <div class="image-gallery" id="image-gallery"></div>
                     <button class='directions-button' id='get-direction'>Get Directions</button>
										 <p class='sidebar-item' id=side-org><strong>Organization/Enterprise: </strong></p>
										 <p class='sidebar-item' id=side-address><strong>Address: </strong></p>
										 <p class='sidebar-item' id=side-city><strong>City: </strong></p>
										 <p class='sidebar-item' id=side-zip><strong>Zip Code: </strong></p>
										 <p class='sidebar-item' id=side-handicap><strong>Handicap Accessible: </strong></p>
										 <p class='sidebar-item' id=side-access><strong>Access: </strong></p>
										 <p class='sidebar-item' id=side-description><strong>Description: </strong></p>
										 <p class='sidebar-item' id=side-tap_type><strong>Tap Type: </strong></p>
										 <p class='sidebar-item' id=side-service><strong>Service: </strong></p>
										 <p class='sidebar-item' id=side-filtration><strong>Filtration: </strong></p>
										 <p class='sidebar-item' id=side-vessel><strong>Water Vessel: </strong></p>
										 <p class='sidebar-item' id=side-statement><strong>Phlask Statement: </strong></p>
										 <p class='sidebar-item' id=side-norms><strong>Norms and Rules: </strong></p>
                     <!-- <button onclick='editData(selected_taps[0])' class="edit-button">Edit</button> -->
                     `
										 // <p class='sidebar-item' id=side-id><strong>Tap ID: </strong></p>
										 // <p class='sidebar-item' id=side-lat><strong>Latitude: </strong></p>
										 // <p class='sidebar-item' id=side-lon><strong>Longitude: </strong></p>


            var gallery = document.getElementById('image-gallery');
            if (data.images) {

              if (data.images.length > 1) {
                scrollButtons = document.getElementById('scroll-buttons');

                var leftButton = document.createElement('BUTTON');
                leftButton.className = 'gallery-left image-btn';
                leftButton.innerHTML = '&#10094;';
                leftButton.setAttribute("onclick", 'plusDivs(-1)');
                leftButton.setAttribute("style", 'margin-right: 5px;');

                var rightButton = document.createElement('BUTTON');
                rightButton.className = 'gallery-left image-btn';
                rightButton.innerHTML = '&#10095;';
                rightButton.setAttribute("onclick", 'plusDivs(1)');

                scrollButtons.appendChild(leftButton);
                scrollButtons.appendChild(rightButton);
              }

              for (i = 0; i < data.images.length; i++) {
                //console.log(data.images[i]);
                var image = document.createElement('img');
                image.className = "side-image"
                image.src = data.images[i];
                image.setAttribute("style", "margin: 2px; height: 100%; width: auto; cursor: pointer; display: inline-block; vertical-align: middle; border: 5px solid #00ADEE ")
                gallery.appendChild(image);
              }
              showDivs(slideIndex);
            }
            else {
              gallery.style.display = 'none'
            }
            const url = "https://www.google.com/maps/search/?api=1&query=" + data.lat + ", " +  data.lon;
            document.getElementById('get-direction').setAttribute('onclick', 'window.open("' + url + '", "_blank")');
            document.getElementById('get-direction').setAttribute('target', "_blank");

						document.getElementById('side-access').innerHTML += data.access;
						document.getElementById('side-service').innerHTML += data.service;
						document.getElementById('side-tap_type').innerHTML += data.tap_type;
						document.getElementById('side-vessel').innerHTML += data.vessel;
						document.getElementById('side-filtration').innerHTML += data.filtration;

						document.getElementById('side-address').innerHTML += data.address;
						document.getElementById('side-city').innerHTML += data.city;
						document.getElementById('side-zip').innerHTML += data.zip_code;
						document.getElementById('side-org').innerHTML += data.organization;

						document.getElementById('side-handicap').innerHTML += data.handicap;
						document.getElementById('side-description').innerHTML += data.description;
						document.getElementById('side-statement').innerHTML += data.statement;
						document.getElementById('side-norms').innerHTML += data.norms_rules;

            $( ".sidebar-item" ).each(function( index, element ) {
              let text = element.innerHTML.split(':', 2)[1].split('>', 2)[1];
              if (text.length < 1) element.style.display = "none";
            });

						// document.getElementById('side-id').innerHTML += data.tapnum;
						// document.getElementById('side-lat').innerHTML+= data.lat;
						// document.getElementById('side-lon').innerHTML += data.lon;
				});
        allTaps.push(tap);
		}

		function getTaps(increment) {
        //allTaps = []
				firebase.database().ref('/').once('value').then(function(snapshot) {
						//console.log(snapshot.val())
						for (item in snapshot.val()) {
								var lat = snapshot.val()[item].lat;
								var lon = snapshot.val()[item].lon;

								var latlng = {lat: lat, lng: lon};

								placeTap(latlng, map, snapshot.val()[item]);

                initialTaps.push(snapshot.val()[item])

                if (increment) {
                  nextTapNumber += 1;
                }
						}
				});
        //console.log(allTaps);
		}

		function getNewTaps() {
				newDatabase.ref('/new_taps').once('value').then(function(snapshot) {
						for (item in snapshot.val()) {
								var lat = snapshot.val()[item].lat
								var lon = snapshot.val()[item].lon

								var latlng = {lat: lat, lng: lon}
								//placeTap(latlng, map, snapshot.val()[item], true)
                nextTapNumber += 1;
						}
				});
		}


       function saveData() {
          try {document.getElementById("message").style.display = "block"}
					catch(err) {}

           var access = document.getElementById('access').value;
           var service = document.getElementById('service').value;
           var tapType = document.getElementById('tap-type').value;
           //var waterType = document.getElementById('water-type').value;
           var vessel = document.getElementById('vessel').value;
           var filtration = document.getElementById('filtration').value;

           var address = document.getElementById('address').value;
           var city = document.getElementById('city').value;
           var zipcode = document.getElementById('zipcode').value;
           var org = document.getElementById('org').value;

           var handicap = document.getElementById('handicap').value;
           var description = document.getElementById('description').value;
           var statement = document.getElementById('statement').value;
           var normsAndRules = document.getElementById('norms-rules').value;

           var latlng = marker.getPosition();

           var fullData = {tapnum: nextTapNumber, access: access, service: service, tap_type: tapType,
                           vessel: vessel, filtration: filtration, address: address, city: city, zip_code: zipcode, organization: org, handicap: handicap, description: description, statement: statement, norms_rules: normsAndRules, lat: latlng.lat(), lon: latlng.lng()};

           newDatabase.ref('new_taps/' + (nextTapNumber).toString()).set(fullData);


           //infowindow.close();
           //newTapMarker = new google.maps.Marker()
           //newTapMarker.setPosition(marker.getPosition())
           //marker.setMap(null)
           marker.setVisible(false);

           messagewindow.open(map, marker);

           getTaps(false);
           placeTap(latlng, map, fullData, true);

           nextTapNumber += 1
           console.log("nextTapNumber after tap submit: " + nextTapNumber);

           const submitMessage = document.getElementById('new-tap-submit');
           // submitMessage.style.display = 'block';
           $('#new-tap-submit').fadeIn(3000);
       }

       function change_icon_back() {
         if (selected_taps.length > 0) {
           var change_icon = selected_taps.pop();
           if (change_icon.data.access == 'Public') {
             change_icon.setIcon(blueTap)
           }
           else if (change_icon.data.access == 'Private') {
             change_icon.setIcon(yellowTap)
           }
           else if (change_icon.data.access == 'Semi-public') {
             change_icon.setIcon(greenTap)
           }
           else if (change_icon.data.access == 'Unverified') {
             change_icon.setIcon(greyTap)
           }
           else if (change_icon.data.access == 'Restricted') {
             change_icon.setIcon(redTap)
           }
           else if (change_icon.data.access == 'Private-Shared') {
             change_icon.setIcon(greenTap)
           }
           else if (change_icon.data.access == 'WM') {
             change_icon.setIcon(HOSR_tap)
           }
         }
       }

       function showDivs(n) {
           var i;
           var x = document.getElementsByClassName("side-image");
           if (n > x.length) {slideIndex = 1}
           if (n < 1) {slideIndex = x.length}
           for (i = 0; i < x.length; i++) {
               x[i].style.display = "none";
           }
           x[slideIndex-1].style.display = "block";
       }

       let slideIndex = 1;
       //showDivs(slideIndex);

       function plusDivs(n) {
           showDivs(slideIndex += n);
       }

       function editData(tap) {
         //console.log(tap);
         const form = document.getElementById("form");
         form.style.display = "none";

         const editForm = document.getElementById("editForm");
         editForm.style.display = "block";

         document.getElementById('new-tap-submit').style.display = 'none';
         document.getElementById('edit-tap-submit').style.display = 'none';
         document.querySelector('.phlask-code-input').style.display = 'block';

         editForm.scrollIntoView();
         window.scrollBy(0, -65);

         // console.log(tap);

         document.getElementById('edit-access').value = tap.data.access;
         document.getElementById('edit-service').value = tap.data.service;
         document.getElementById('edit-tap-type').value = tap.data.tap_type;
         document.getElementById('edit-vessel').value = tap.data.vessel;
         document.getElementById('edit-filtration').value = tap.data.filtration;

         document.getElementById('edit-address').value = tap.data.address;
         document.getElementById('edit-city').value = tap.data.city;
         document.getElementById('edit-zipcode').value = tap.data.zip_code;
         document.getElementById('edit-org').value = tap.data.organization;

         document.getElementById('edit-handicap').value = tap.data.handicap;
         document.getElementById('edit-description').value = tap.data.description;
         document.getElementById('edit-statement').value = tap.data.statement;
         document.getElementById('edit-norms-rules').value = tap.data.norms_rules;

         const saveButton = document.querySelector(".edit-submit");
         saveButton.addEventListener('click', () => {
           const phlaskCodeText = document.querySelector(".phlask-code-input").value;
           // console.log(tap);
           if (phlaskCodeText === 'phlaskme123') {
             saveEdit(true, tap);
           }
           else { alert("You need the Phlask edit code to make edits.") }
         })
       }

       function saveEdit(correctCode, tap) {
         if (correctCode) {
           var access = document.getElementById('edit-access').value;
           var service = document.getElementById('edit-service').value;
           var tapType = document.getElementById('edit-tap-type').value;
           //var waterType = document.getElementById('water-type').value;
           var vessel = document.getElementById('edit-vessel').value;
           var filtration = document.getElementById('edit-filtration').value;

           var address = document.getElementById('edit-address').value;
           var city = document.getElementById('edit-city').value;
           var zipcode = document.getElementById('edit-zipcode').value;
           var org = document.getElementById('edit-org').value;

           var handicap = document.getElementById('edit-handicap').value;
           var description = document.getElementById('edit-description').value;
           var statement = document.getElementById('edit-statement').value;
           var normsAndRules = document.getElementById('edit-norms-rules').value;

           let editData = {
             tapnum: tap.data.tapnum, access: access, service: service, tap_type: tapType,
             vessel: vessel, filtration: filtration, address: address, city: city, zip_code: zipcode,
             organization: org, handicap: handicap, description: description, statement: statement,
             norms_rules: normsAndRules, lat: tap.data.lat, lon: tap.data.lon
           };
           console.log(editData);
           const editSuccessMessage = document.getElementById("edit-tap-submit")
           // editSuccessMessage.style.display = "block"
           editSuccessMessage.textContent = 'Tap Successfully Edited'
           $('#edit-tap-submit').fadeIn(3000);


           database.ref('/' + (tap.data.tapnum).toString()).set(editData);

           getTaps(false);
         }
       }


       //document.querySelector('#latlon-input').style.display = 'none';
       //document.querySelector('#latlon-button').style.display = 'none';


       let filtered = false;
       function accessFilter(type) {
         for (let i = 0; i < allTaps.length; i++) {
           allTaps[i].setMap(map);
         }

         for (let i = 0; i < initialTaps.length; i++) {
           if (initialTaps[i].access != type) {
             allTaps[i].setMap(null);
           }

         // if (accessFilterType == type) {
         //   for (let i = 0; i < allTaps.length; i++) {
         //     allTaps[i].setMap(map);
         //   }
         // }
         //
         // else {
         //   for (let i = 0; i < allTaps.length; i++) {
         //     allTaps[i].setMap(map);
         //   }
         //
         //   for (let i = 0; i < initialTaps.length; i++) {
         //     if (initialTaps[i].access != type) {
         //       allTaps[i].setMap(null);
         //     }
         //   }
         }
         accessFilterType = type;
       }



       document.getElementById('latlon-button').addEventListener('click', function(){
         zoomToArea();
       });

       const zoomAutocomplete = new google.maps.places.Autocomplete(
           document.getElementById('latlon-input'));

          // This function takes the input value in the find nearby area text input locates it, and then zooms into that area. This is so that the user can show all, listings, then decide to focus on one area of the map.
       function zoomToArea(){
         // initialize geocoder, new geocode instance
         const geocoder = new google.maps.Geocoder();
         // get address or place that the user entered
         const address = document.getElementById('latlon-input').value;
         // make sre the address isnt blank
         if (address == '') {
           window.alert('You must enter an area, or address.');
         } else {
           // Geocode the address/area entered to get the center. Then, center the map on it and zoom in
           geocoder.geocode(
             { address: address,
               // keep it with in the city
               componentRestrictions: {locality: 'Philadelphia'}
           }, function(results, status) {
             if (status == google.maps.GeocoderStatus.OK) {
               // use resulting lat long to recenter the map
               map.setCenter(results[0].geometry.location);
               map.setZoom(20);

               addressMarkers.forEach( (element) => {
                 element.setMap(null);
               });

               const marker = new google.maps.Marker({
                 position: results[0].geometry.location,
                 animation: google.maps.Animation.DROP,
                 map: map
                 });

               addressMarkers.push(marker);

             } else {
               window.alert('We could not find that location - try entering a more' + ' specific place.');
             }

           });
         }
       }
			</script>
		</div><!-- #primary -->
	</div>
</body>
</html>
